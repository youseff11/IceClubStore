{% extends 'base.html' %} 
{% block content %}
<style>
    :root {
        --primary-color: #4fc3f7;
        --secondary-color: #0f2027;
        --accent-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
        --glass-bg: rgba(255, 255, 255, 0.03);
        --glass-border: rgba(255, 255, 255, 0.1);
        --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        --discount-color: #ff5252;
        --text-muted: rgba(255, 255, 255, 0.6);
        --card-height: 700px; 
    }

    body {
        margin: 0;
        background-color: #0f2027;
        color: #fff;
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    .detail-wrapper {
        padding: 100px 20px;
        background: var(--accent-gradient);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .detail-container-outer {
        position: relative;
        max-width: 1100px;
        width: 100%;
        height: var(--card-height); 
        border-radius: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        padding: 2px;
        box-shadow: 0 40px 100px rgba(0,0,0,0.6);
    }

    .detail-container-outer::before {
        content: '';
        position: absolute;
        width: 150%;
        height: 150%;
        background-image: conic-gradient(transparent, transparent, transparent, var(--primary-color));
        animation: rotateLight 5s linear infinite;
    }

    @keyframes rotateLight {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .detail-container {
        position: relative;
        z-index: 5;
        width: 100%;
        height: 100%; 
        display: grid;
        grid-template-columns: 1.1fr 0.9fr;
        gap: 0;
        background: #0f2027;
        border-radius: 28px;
        overflow: hidden;
    }

    .image-section {
        position: relative;
        background: #15262d;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        border-right: 1px solid var(--glass-border);
        height: 100%; 
        overflow: hidden;
    }

    .detail-sold-out-badge {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-15deg);
        background: rgba(0,0,0,0.85);
        color: #ff5252;
        padding: 15px 30px;
        border: 3px solid #ff5252;
        font-size: 2rem;
        font-weight: 900;
        z-index: 20;
        display: none;
        pointer-events: none;
        border-radius: 15px;
        box-shadow: 0 0 30px rgba(255,82,82,0.3);
    }

    .detail-discount-badge {
        position: absolute;
        top: 30px;
        left: 30px;
        background: var(--discount-color);
        color: white;
        padding: 6px 15px;
        border-radius: 10px;
        font-weight: 800;
        z-index: 10;
    }

    .product-main-img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 20px;
        transition: var(--transition-smooth);
        filter: drop-shadow(0 20px 30px rgba(0,0,0,0.5));
    }

    .is-out-of-stock img {
        filter: grayscale(0.8) brightness(0.5);
    }

    .info-section {
        padding: 40px 60px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        height: 100%;
        background: rgba(255, 255, 255, 0.01);
    }

    .category-label {
        color: var(--primary-color);
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 3px;
        margin-bottom: 10px;
        display: block;
    }

    .product-title {
        font-size: clamp(1.8rem, 3vw, 2.5rem);
        font-weight: 800;
        margin: 0 0 15px 0;
        line-height: 1.1;
    }

    .price-group {
        display: flex;
        align-items: baseline;
        gap: 20px;
        margin-bottom: 20px;
    }

    .current-price {
        font-size: 1.8rem;
        color: #fff;
        font-weight: 700;
    }

    .old-price {
        font-size: 1.1rem;
        text-decoration: line-through;
        color: var(--text-muted);
    }

    .size-selection {
        margin-bottom: 25px;
    }

    .size-options {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        flex-wrap: wrap;
    }

    .size-chip {
        padding: 8px 18px;
        border: 1px solid var(--glass-border);
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition-smooth);
        background: rgba(255,255,255,0.05);
    }

    .size-chip:hover:not(.out-of-stock) {
        border-color: var(--primary-color);
    }

    .size-chip.active {
        background: var(--primary-color);
        color: var(--secondary-color);
        border-color: var(--primary-color);
    }

    .size-chip.out-of-stock {
        opacity: 0.3;
        text-decoration: line-through;
        cursor: not-allowed;
    }

    .color-dots {
        display: flex;
        gap: 12px;
        margin: 10px 0 25px;
    }

    .color-dot {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid transparent;
        transition: var(--transition-smooth);
        background-clip: content-box;
        padding: 3px;
    }

    .color-dot.active {
        border-color: var(--primary-color);
        transform: scale(1.15);
    }

    .product-description {
        color: var(--text-muted);
        line-height: 1.5;
        font-size: 0.9rem;
        margin-bottom: 25px;
    }

    .action-btns {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }

    .btn-primary, .btn-back {
        padding: 16px;
        border-radius: 12px;
        font-weight: 700;
        text-decoration: none;
        transition: var(--transition-smooth);
        text-align: center;
    }

    .btn-primary {
        flex: 2;
        background: var(--primary-color);
        color: var(--secondary-color);
    }

    .btn-back {
        flex: 1;
        border: 1px solid var(--glass-border);
        color: #fff;
    }

    .btn-primary:hover:not(.btn-disabled) {
        background: #fff;
        transform: translateY(-3px);
    }

    .btn-disabled {
        background: #222 !important;
        color: #555 !important;
        cursor: not-allowed;
        pointer-events: none;
        border: 1px solid #333;
    }

    @media (max-width: 992px) {
        .detail-container-outer { height: auto; }
        .detail-container { grid-template-columns: 1fr; }
        .image-section { height: 350px; border-right: none; border-bottom: 1px solid var(--glass-border); }
        .info-section { padding: 30px; }
    }
</style>

<div class="detail-wrapper">
    <div class="detail-container-outer">
        <div class="detail-container">
            
            <div class="image-section" id="imgSection">
                <div class="detail-sold-out-badge" id="soldOutLabel">SOLD OUT</div>
                
                {% if product.discount_price %}
                    <div class="detail-discount-badge">{{ product.discount_percentage }}% OFF</div>
                {% endif %}

                <img src="{{ product.main_image.url }}" alt="{{ product.name }}" id="mainDetailImg" class="product-main-img">
            </div>

            <div class="info-section">
                <div class="top-info">
                    <span class="category-label">{{ product.category.name|default:"Premium Collection" }}</span>
                    <h1 class="product-title">{{ product.name }}</h1>
                    
                    <div class="price-group">
                        {% if product.discount_price %}
                            <span class="current-price">{{ product.discount_price|floatformat:0 }} LE</span>
                            <span class="old-price">{{ product.price|floatformat:0 }} LE</span>
                        {% else %}
                            <span class="current-price">{{ product.price|floatformat:0 }} LE</span>
                        {% endif %}
                    </div>

                    <div class="color-selection">
                        <h4 style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px;">Color: <span id="selected-color-name" style="color: var(--primary-color);">Select Color</span></h4>
                        <div class="color-dots">
                            {% for variant in product.variants.all %}
                            <div class="color-dot {% if forloop.first %}active{% endif %}" 
                                 style="background-color: {{ variant.color_code }};" 
                                 data-color="{{ variant.color_name }}"
                                 data-img="{{ variant.variant_image.url }}"
                                 onclick="selectVariant(this)">
                                 <script type="application/json" class="variant-sizes-data">
                                    [
                                        {% for size in variant.sizes.all %}
                                        {"name": "{{ size.size_name }}", "stock": {{ size.stock }}}{% if not forloop.last %},{% endif %}
                                        {% endfor %}
                                    ]
                                 </script>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="size-selection">
                        <h4 style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px;">Size: <span id="selected-size-name" style="color: var(--primary-color);">Choose</span></h4>
                        <div class="size-options" id="sizeOptionsContainer">
                        </div>
                    </div>

                    <p class="product-description">
                        {{ product.description|default:"Experience the perfect blend of style and comfort with this exclusive piece." }}
                    </p>
                </div>

                <div class="action-btns">
                    <a href="#" id="add-to-cart-btn" class="btn-primary">
                        Add to Cart
                    </a>
                    <a href="{% url 'shop' %}" class="btn-back">Back</a>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    let currentSelectedColor = "";
    let currentSelectedSize = "";

    function selectVariant(element) {
        const colorName = element.getAttribute('data-color');
        const imageUrl = element.getAttribute('data-img');
        const sizesData = JSON.parse(element.querySelector('.variant-sizes-data').textContent);
        
        const imgSection = document.getElementById('imgSection');
        const soldOutLabel = document.getElementById('soldOutLabel');
        const mainImg = document.getElementById('mainDetailImg');
        const sizeContainer = document.getElementById('sizeOptionsContainer');
        const sizeNameDisplay = document.getElementById('selected-size-name');

        // 1. حساب إجمالي المخزون للون المختار
        const totalColorStock = sizesData.reduce((acc, curr) => acc + curr.stock, 0);

        // 2. تحديث اللون المختار والصورة
        currentSelectedColor = colorName;
        document.getElementById('selected-color-name').innerText = colorName;
        
        mainImg.style.opacity = '0.5';
        setTimeout(() => {
            mainImg.src = imageUrl;
            mainImg.style.opacity = '1';
        }, 150);

        // 3. التحقق مما إذا كان اللون بالكامل SOLD OUT
        if (totalColorStock === 0) {
            imgSection.classList.add('is-out-of-stock');
            soldOutLabel.style.display = 'block';
        } else {
            imgSection.classList.remove('is-out-of-stock');
            soldOutLabel.style.display = 'none';
        }

        // 4. تحديث قائمة المقاسات
        sizeContainer.innerHTML = "";
        currentSelectedSize = ""; 
        sizeNameDisplay.innerText = "Choose";

        sizesData.forEach(size => {
            const chip = document.createElement('div');
            chip.className = `size-chip ${size.stock === 0 ? 'out-of-stock' : ''}`;
            chip.innerText = size.name;
            chip.onclick = () => {
                if(size.stock > 0) selectSize(chip, size.name);
            };
            sizeContainer.appendChild(chip);
        });

        document.querySelectorAll('.color-dot').forEach(dot => dot.classList.remove('active'));
        element.classList.add('active');

        updateCartButton();
    }

    function selectSize(element, sizeName) {
        currentSelectedSize = sizeName;
        document.getElementById('selected-size-name').innerText = sizeName;
        
        document.querySelectorAll('.size-chip').forEach(chip => chip.classList.remove('active'));
        element.classList.add('active');

        updateCartButton();
    }

    function updateCartButton() {
        const btn = document.getElementById('add-to-cart-btn');
        const productId = "{{ product.id }}";
        
        if (currentSelectedColor && currentSelectedSize) {
            btn.classList.remove('btn-disabled');
            btn.innerText = "Add to Cart";
            btn.href = `/add-to-cart/${productId}/?color=${encodeURIComponent(currentSelectedColor)}&size=${encodeURIComponent(currentSelectedSize)}`;
        } else {
            btn.classList.add('btn-disabled');
            btn.innerText = (document.getElementById('soldOutLabel').style.display === 'block') ? "Out of Stock" : "Select Size";
            btn.href = "#";
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const firstColor = document.querySelector('.color-dot');
        if (firstColor) firstColor.click();
    });
</script>
{% endblock %}